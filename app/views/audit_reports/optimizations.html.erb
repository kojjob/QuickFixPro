<!-- Optimizations View -->
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
  <div class="container mx-auto px-4 py-8">
    
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Website Optimizations</h1>
          <p class="text-gray-600">Manage and track optimization recommendations for your websites</p>
        </div>
        <div class="flex items-center space-x-3">
          <%= link_to "Generate New Recommendations", schedule_audit_website_audit_reports_path(@website), 
                     class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors" %>
          <%= link_to "View All Audits", all_audits_website_audit_reports_path(@website), 
                     class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors" %>
        </div>
      </div>
    </div>

    <!-- Optimization Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-600 text-sm font-medium">Implemented</p>
            <p class="text-2xl font-bold text-gray-900"><%= @optimization_stats[:implemented] %></p>
          </div>
          <div class="p-3 bg-green-100 rounded-full">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-600 text-sm font-medium">In Progress</p>
            <p class="text-2xl font-bold text-gray-900"><%= @optimization_stats[:in_progress] %></p>
          </div>
          <div class="p-3 bg-blue-100 rounded-full">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-600 text-sm font-medium">Pending</p>
            <p class="text-2xl font-bold text-gray-900"><%= @optimization_stats[:pending] %></p>
          </div>
          <div class="p-3 bg-orange-100 rounded-full">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-600 text-sm font-medium">Impact Score</p>
            <p class="text-2xl font-bold text-gray-900"><%= @optimization_stats[:avg_impact] %></p>
          </div>
          <div class="p-3 bg-purple-100 rounded-full">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Priority Recommendations -->
    <div class="mb-8">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">High Priority Recommendations</h2>
          <span class="bg-red-100 text-red-800 text-sm font-medium px-3 py-1 rounded-full">
            <%= @priority_recommendations.count %> Critical Issues
          </span>
        </div>
        
        <% if @priority_recommendations.any? %>
          <div class="space-y-4">
            <% @priority_recommendations.each do |rec| %>
              <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-lg">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h3 class="font-semibold text-gray-900 mb-2"><%= rec[:title] %></h3>
                    <p class="text-gray-600 text-sm mb-2"><%= rec[:description] %></p>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                      <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                        Impact: <%= rec[:impact] %>
                      </span>
                      <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Effort: <%= rec[:effort] %>
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center space-x-2 ml-4">
                    <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors"
                            onclick="markAsImplemented('<%= rec[:id] %>')">
                      Mark Done
                    </button>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                            onclick="viewDetails('<%= rec[:id] %>')">
                      Details
                    </button>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8">
            <svg class="w-16 h-16 text-green-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Critical Issues!</h3>
            <p class="text-gray-600">Your website is performing well with no high-priority optimizations needed.</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Filter and Search Controls -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-wrap gap-4 items-center justify-between">
        <div class="flex flex-wrap gap-4">
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Category:</label>
            <select class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onchange="filterOptimizations()">
              <option value="">All Categories</option>
              <option value="performance">Performance</option>
              <option value="seo">SEO</option>
              <option value="accessibility">Accessibility</option>
              <option value="security">Security</option>
              <option value="usability">Usability</option>
            </select>
          </div>
          
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Status:</label>
            <select class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onchange="filterOptimizations()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="implemented">Implemented</option>
              <option value="dismissed">Dismissed</option>
            </select>
          </div>
          
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">Priority:</label>
            <select class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onchange="filterOptimizations()">
              <option value="">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <div class="relative">
            <input type="text" placeholder="Search optimizations..." 
                   class="border border-gray-300 rounded-lg px-4 py-2 pl-10 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64"
                   onkeyup="searchOptimizations()">
            <svg class="absolute left-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                  onclick="exportOptimizations()">
            Export CSV
          </button>
        </div>
      </div>
    </div>

    <!-- Optimizations List -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900">All Optimization Recommendations</h2>
      </div>
      
      <div class="divide-y divide-gray-200">
        <% @optimizations.each do |optimization| %>
          <div class="p-6 hover:bg-gray-50 transition-colors optimization-item" 
               data-category="<%= optimization[:category] %>" 
               data-status="<%= optimization[:status] %>" 
               data-priority="<%= optimization[:priority] %>">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                  <h3 class="font-semibold text-gray-900"><%= optimization[:title] %></h3>
                  
                  <!-- Priority Badge -->
                  <% case optimization[:priority] %>
                  <% when 'high' %>
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">High Priority</span>
                  <% when 'medium' %>
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">Medium Priority</span>
                  <% when 'low' %>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">Low Priority</span>
                  <% end %>
                  
                  <!-- Status Badge -->
                  <% case optimization[:status] %>
                  <% when 'implemented' %>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">✓ Implemented</span>
                  <% when 'in_progress' %>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">⏳ In Progress</span>
                  <% when 'pending' %>
                    <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded-full">⏸ Pending</span>
                  <% when 'dismissed' %>
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">✕ Dismissed</span>
                  <% end %>
                  
                  <!-- Category Badge -->
                  <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded-full">
                    <%= optimization[:category].capitalize %>
                  </span>
                </div>
                
                <p class="text-gray-600 text-sm mb-3"><%= optimization[:description] %></p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <span>Impact: <strong><%= optimization[:impact] %>/10</strong></span>
                  </div>
                  <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Effort: <strong><%= optimization[:effort] %></strong></span>
                  </div>
                  <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Created: <strong><%= optimization[:created_at] %></strong></span>
                  </div>
                  <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Score: <strong><%= optimization[:score] %></strong></span>
                  </div>
                </div>
                
                <% if optimization[:steps]&.any? %>
                  <div class="mt-4">
                    <button class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center"
                            onclick="toggleSteps('<%= optimization[:id] %>')">
                      <span>View Implementation Steps</span>
                      <svg class="w-4 h-4 ml-1 transform transition-transform" id="arrow-<%= optimization[:id] %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </button>
                    <div class="mt-2 pl-4 border-l-2 border-blue-200 hidden" id="steps-<%= optimization[:id] %>">
                      <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <% optimization[:steps].each do |step| %>
                          <li><%= step %></li>
                        <% end %>
                      </ol>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <div class="flex flex-col space-y-2 ml-4">
                <% unless optimization[:status] == 'implemented' %>
                  <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                          onclick="updateStatus('<%= optimization[:id] %>', 'implemented')">
                    Mark Complete
                  </button>
                <% end %>
                
                <% if optimization[:status] == 'pending' %>
                  <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                          onclick="updateStatus('<%= optimization[:id] %>', 'in_progress')">
                    Start Work
                  </button>
                <% end %>
                
                <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        onclick="showDetails('<%= optimization[:id] %>')">
                  View Details
                </button>
                
                <button class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        onclick="dismissOptimization('<%= optimization[:id] %>')">
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Pagination -->
      <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">
            Showing <%= (@current_page - 1) * @per_page + 1 %> to 
            <%= [@current_page * @per_page, @total_optimizations].min %> of 
            <%= @total_optimizations %> optimizations
          </div>
          <div class="flex items-center space-x-2">
            <% if @current_page > 1 %>
              <a href="?page=<%= @current_page - 1 %>" class="bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded border text-sm">Previous</a>
            <% end %>
            
            <% ([@current_page - 2, 1].max..[@current_page + 2, @total_pages].min).each do |page| %>
              <% if page == @current_page %>
                <span class="bg-blue-600 text-white px-3 py-2 rounded text-sm"><%= page %></span>
              <% else %>
                <a href="?page=<%= page %>" class="bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded border text-sm"><%= page %></a>
              <% end %>
            <% end %>
            
            <% if @current_page < @total_pages %>
              <a href="?page=<%= @current_page + 1 %>" class="bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded border text-sm">Next</a>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Interactions -->
<script nonce="<%= csp_nonce %>">
function filterOptimizations() {
  const category = document.querySelector('select[onchange="filterOptimizations()"]').value;
  const status = document.querySelectorAll('select[onchange="filterOptimizations()"]')[1].value;
  const priority = document.querySelectorAll('select[onchange="filterOptimizations()"]')[2].value;
  
  document.querySelectorAll('.optimization-item').forEach(item => {
    const itemCategory = item.dataset.category;
    const itemStatus = item.dataset.status;
    const itemPriority = item.dataset.priority;
    
    const show = (!category || itemCategory === category) &&
                 (!status || itemStatus === status) &&
                 (!priority || itemPriority === priority);
    
    item.style.display = show ? 'block' : 'none';
  });
}

function searchOptimizations() {
  const query = document.querySelector('input[placeholder="Search optimizations..."]').value.toLowerCase();
  
  document.querySelectorAll('.optimization-item').forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(query) ? 'block' : 'none';
  });
}

function toggleSteps(id) {
  const steps = document.getElementById(`steps-${id}`);
  const arrow = document.getElementById(`arrow-${id}`);
  
  if (steps.classList.contains('hidden')) {
    steps.classList.remove('hidden');
    arrow.style.transform = 'rotate(180deg)';
  } else {
    steps.classList.add('hidden');
    arrow.style.transform = 'rotate(0deg)';
  }
}

function updateStatus(id, status) {
  // In a real app, this would make an AJAX call to update the status
  console.log(`Updating optimization ${id} to status: ${status}`);
  
  // Show success message
  const message = status === 'implemented' ? 'Optimization marked as completed!' : 'Status updated successfully!';
  alert(message);
  
  // Reload page to reflect changes
  window.location.reload();
}

function showDetails(id) {
  // In a real app, this would show a modal with detailed information
  console.log(`Showing details for optimization ${id}`);
  alert('Detailed view would open here with comprehensive information about this optimization.');
}

function dismissOptimization(id) {
  if (confirm('Are you sure you want to dismiss this optimization recommendation?')) {
    console.log(`Dismissing optimization ${id}`);
    alert('Optimization dismissed successfully!');
    window.location.reload();
  }
}

function exportOptimizations() {
  // In a real app, this would generate and download a CSV file
  console.log('Exporting optimizations to CSV');
  alert('Export functionality would generate a CSV file with all optimization data.');
}

function markAsImplemented(id) {
  updateStatus(id, 'implemented');
}

function viewDetails(id) {
  showDetails(id);
}
</script>